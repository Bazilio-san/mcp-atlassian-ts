# Как отлаживать MCP инструменты и соответствующие им тесты по одному

Например, дается задание отладить инструмент `<имя_инструмента>`


1) Гасишь MCP сервер, если он запущен с помощью scripts/kill-3000.js
   Удаляешь папку _tmp/_logs: rimraf _tmp/_logs   

2) Запускаешь MCP сервер 
   node dist/src/index.js

3) запускаешь тест инструмента
   node.exe tests\mcp\jira.js --tests=<имя_инструмента>

4) Смотришь:
   - вывод теста в STDIO
   И делаешь выводы, прошел тест или нет. 
   
5) Если прошел, то сообщаешь об успехе и останавливаешься


6) Если тест не прошел.
    - останавливаешь MCP сервер (см. п. 1)
    - смотришь лог файл tests/mcp/_logs/jira/<имя_инструмента>.md (запрос и ответ инструмента MCP)
    - смотришь лог файл _tmp/_logs/HTTP_<имя_инструмента>.md (запрос и ответ в API (JIRA/confluence))
    - делаешь выводы о том, что является причиной ошибки, как ее можно устранить
    - читаешь раздел `# Решение проблем. Пополняемая часть.` и используешь эти знания для выявления известных проблем.
    - Чинишь:
        - Могут быть причины в недостатках параметров инструмента или в логике инструмента или в обработчике - чинишь 
        - Могут быть причины в недостатке передаваемых данных - чинишь 
        - Могут быть причины в самом тесте. Например, его надо расширить - чинишь 
        - Могут быть прочие причины - выявляешь и чинишь 
    - выполняешь команду удаления папки dist: `rimraf dist`
    - выполняешь сборки проекта: `tsc`
    - перезапускаешь (см. п. 2,3,4), и так до 5 раз.
    - Если тест после починки прошел, пополни раздел `# Решение проблем. Пополняемая часть.`
      сведениями о найденной проблеме, как ее быстро идентифицировать в другой раз и как устранить. 
    - Если тест после починки прошел успешно, действуешь по п. 5.



# Дополнительные указания

1) Если какие-нибудь инструкции по запуску не соответтсвуют действительности, замени из на те команды и описание
   окружения запуска, которые были найдены тобой для решения задачи

2) Базовый URL для JIRA API, указанный в .env в JIRA_URL - всегда верный.
   например
   JIRA_URL=https://jira-dev.finam.ru/rest/scriptrunner/latest/custom/action - правильно 
   Это эндпоинт с имперсонализацией, требующий обязательной передачи логинаа пользователя в HTTP заголовке x-finam-user
   JIRA_URL=https://jira-dev.finam.ru - тоже правильно (без имперсонализации)

3) Прими во внимание, что в некоторых случаях у пользователя просто может не хватать прав для 
   выполненния операции через эндпоинт jira.
   В этом случае необходимо, чтобы MCP сервер (инструмент) возвращал в составе объекта ошибки указание на недостаточность 
   прав на человеческом языке. Для этого можешь вносить исправления в код MCP сервера




================================================================================
# Решение проблем. Пополняемая часть.

**Указание:** пополняй эту часть найденными знаниями в процессе починки предыдущих тестов. Не дублируй информацию. 
описывай решение проблемы так, чтобы в следующий раз было понятно как быстро проверить гипотезу 
наличия бага именно из-за этой проблемы

--------------------------------------------------------------------------------

## НЕ доезжает до вызова эндпоинта JIRA API кастомный HTTP заголовок x-finam-user

он задан в переменной окружения TEST_ADD_X_HEADER=x-finam-user:ashapovalov 
и должен транзитом передаваться в HTTP заголовке при вызове MCP сервера клиентом из тестера.
А там, как кастомный заголовок, транзитом передаваться в хендлер и попадать в вызов эндпоинта JIRA API.

## Параметр, передаваемый в инструмент и далее в эндпоинт JIRA API не валидный, отсутсвует

Например, проверяем инструмент получения/удаления/обновления какой-нибудь сущности по ID.
И получаем ошибку, что сущность не найдена.

Как исправить:
Правим тест, так, чтобы он был комплексным. Сначала создание сущности, получение ее IDб а потом - действие как тест.



## Неправильные значения параметров в тестах

**Проблема:** Тесты используют значения параметров, которые не существуют или недействительны в JIRA.

**Симптомы:**
- `Resource with identifier 'unknown' not found`
- `не найден тип связи`, `переход недействителен`

**Решение:**

расширить тест-кейс в `tests/mcp/jira-test-cases.js` получением валидных данных 
перед вызовом основного тестируемого инструмента. И при вызове передавать валидные параметры.

Пример:
   - Для переходов: сначала найти актуальный ID (например, 831 вместо 11) и его использовать в основном тесте
   - Для типов связей: сначала найти существующий тип (например, 'Relationship' вместо 'Relates') и его использовать в основном тесте

## Проблемы с кешем при ошибках API

**Проблема:** Когда API возвращает ошибку, кеш-менеджер выбрасывает CacheError вместо обработки ошибки API.

**Симптомы:**
- `Failed to get or set cache value for key` при ошибках API
- Реальная ошибка API скрыта за ошибкой кеша

**Решение:**
Изменить метод `getOrSet` в `src/core/cache/index.ts`, чтобы он пробрасывал ошибки от factory функции как есть, а не оборачивал их в `CacheError`. Разделить обработку ошибок:
- Ошибки чтения/записи кеша - логировать, но продолжать работу
- Ошибки factory функции (API) - пробрасывать без изменений

## Проблемы с обработкой undefined полей в jira_search_fields

**Проблема:** При фильтрации полей JIRA, некоторые поля могут не иметь свойств name или key, что приводит к ошибке `Cannot read properties of undefined (reading 'toLowerCase')`.

**Симптомы:**
- TypeError при вызове метода `toLowerCase()` на undefined
- Ошибка в строках фильтрации полей по запросу

**Решение:**
Добавить проверки на существование свойств перед вызовом методов:
- При фильтрации: проверять `field.name && field.name.toLowerCase()`
- При формировании списка: использовать fallback значения `field.name || field.id || 'Unnamed field'`
- Добавить проверку по полю `field.id` как дополнительный критерий поиска

## Тест jira_create_version - использование несуществующего projectId

**Проблема:** Тест использовал хардкод projectId='10000', который может не существовать в системе.

**Симптомы:**
- Ошибка: `Проект с ключом 'null' не существует или у Вас нет разрешения на создание версий в нем`
- Ошибка: `Resource with identifier 'unknown' not found`

**Решение:**
Сделать тест комплексным - сначала получить список существующих проектов через `jira_get_projects`, затем использовать ID первого доступного проекта:

```javascript
params: async (client) => {
  const { result: projectsResult } = await client.callTool('jira_get_projects', {});
  if (!projectsResult || !projectsResult.projects || projectsResult.projects.length === 0) {
    return null; // Пропустить тест
  }
  const project = projectsResult.projects[0];
  return {
    projectId: project.id,
    name: `MCP-Test-v${Date.now()}`,
    description: 'Created via MCP HTTP test',
  };
}
``` 

