# Как отлаживать MCP инструменты и соответствующие им тесты по одному

Например, дается задание отладить инструмент `jira_get_transitions`


1) Гасишь MCP сервер, если он запущен с помощью scripts/kill-3000.js

2) Запускаешь MCP сервер 
   node dist/src/index.js

3) запускаешь тест инструмента
   node.exe tests\mcp\jira.js --tests=jira_get_transitions

4) Смотришь вывод теста
   смотришь лог файл tests/mcp/_logs/jira/1-1_jira_get_issue.md
   И делаешь выводы, прошел тест или нет. 
   
5) Если прошел, то сообщаешь об успехе и останавливаешься


6) Если тест не прошел.
   - останавливаешь MCP сервер (см. п. 1)
   - читаешь раздел `# Решение проблем. Пополняемая часть.` и используешь эти знания для выявления известных проблем.
   - Чинишь
   - перезапускаешь (см. п. 2,3,4), и так до 5 раз.
   - Если тест после починки прошел, пополни раздел `# Решение проблем. Пополняемая часть.`
     сведениями о найденной проблеме, как ее быстро идентифицировать в другой раз и как устранить. 
   - Если тест после починки прошел успешно, действуешь по п. 5.



# Дополнительные указания

1) Если какие-нибудь инструкции по запуску не соответтсвуют действительности, замени из на те команды и описание
   окружения запуска, которые были найдены тобой для решения задачи

2) Базовый URL для JIRA API, указанный в .env в JIRA_URL - всегда верный.
   например
   JIRA_URL=https://jira-dev.finam.ru/rest/scriptrunner/latest/custom/action - правильно 
   Это эндпоинт с имперсонализацией, требующий обязательной передачи логинаа пользователя в HTTP заголовке x-finam-user
   JIRA_URL=https://jira-dev.finam.ru - тоже правильно (без имперсонализации)

3) Прими во внимание, что в некоторых случаях у пользователя просто может не хватать прав для 
   выполненния операции через эндпоинт jira.
   В этом случае необходимо, чтобы MCP сервер (инструмент) возвращал в составе объекта ошибки указание на недостаточность 
   прав на человеческом языке. Для этого можешь вносить исправления в код MCP сервера
4) 



================================================================================
# Решение проблем. Пополняемая часть.

**Указание:** пополняй эту часть найденными знаниями в процессе починки предыдущих тестов. Не дублируй информацию. 
описывай решение проблемы так, чтобы в следующий раз было понятно как быстро проверить гипотезу 
наличия бага именно из-за этой проблемы

--------------------------------------------------------------------------------

## НЕ доезжает до вызова эндпоинта JIRA API кастомный HTTP заголовок x-finam-user

он задан в переменной окружения TEST_ADD_X_HEADER=x-finam-user:ashapovalov 
и должен транзитом передаваться в HTTP заголовке при вызове MCP сервера клиентом из тестера.
А там, как кастомный заголовок, транзитом передаваться в хендлер и попадать в вызов эндпоинта JIRA API.

## Параметр, передаваемый в инструмент и далее в эндпоинт JIRA API не валидный, отсутсвует

Например, проверяем инструмент получения/удаления/обновления какой-нибудь сущности по ID.
И получаем ошибку, что сущность не найдена.

Как исправить:
Правим тест, так, чтобы он был комплексным. Сначала создание сущности, получение ее IDб а потом - действие как тест.



## Неправильные значения параметров в тестах

**Проблема:** Тесты используют значения параметров, которые не существуют или недействительны в JIRA.

**Симптомы:**
- `Resource with identifier 'unknown' not found`
- `не найден тип связи`, `переход недействителен`

**Быстрая проверка:**
1. Запустить тесты для получения допустимых значений:
   - `jira_get_transitions` - для получения ID переходов
   - `jira_get_link_types` - для получения типов связей
2. Сравнить с используемыми в тестах значениями

**Решение:**
1. Получить актуальные значения из JIRA
2. Обновить тест-кейсы в `tests/mcp/jira-test-cases.js`:
   - Для переходов: использовать актуальный ID (например, 831 вместо 11)
   - Для типов связей: использовать существующий тип (например, 'Relationship' вместо 'Relates')

## Проблемы с кешем при ошибках API

**Проблема:** Когда API возвращает ошибку, кеш-менеджер выбрасывает CacheError вместо обработки ошибки API.

**Симптомы:**
- `Failed to get or set cache value for key` при ошибках API
- Реальная ошибка API скрыта за ошибкой кеша

**Временное решение:**
- Убедиться, что базовый URL правильный
- Проверить доступность API эндпоинтов
- При необходимости очистить кеш

## Поля эпиков и кастомные поля

**Проблема:** Поле для эпика (customfield_10014) не может быть установлено.

**Симптомы:**
- Ошибка `Field 'customfield_10014' cannot be set. It is not on the appropriate screen, or unknown`

**Возможные причины:**
- Поле не доступно для данного типа задачи
- Поле требует специальных прав доступа
- ID поля отличается в разных инстансах JIRA

**Решение:**
- Проверить правильный ID поля эпика для вашей JIRA
- Убедиться, что задача может быть связана с эпиком


